<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>愿望清单</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <!-- 引入 LeanCloud SDK -->
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>

  <style>
    /* --- 液态玻璃 & 苹果风格 definition --- */
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, "SF Pro Text", "Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif;
      color: #1d1d1f;
      -webkit-font-smoothing: antialiased;
      overflow: hidden;
      background-color: #f0f2f5;
    }

    /* 背景流体光斑容器 */
    .blob-cont {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      z-index: -1;
      overflow: hidden;
      background: #f5f5f7;
    }

    /* 流体光斑 */
    .blob {
      position: absolute;
      border-radius: 50%;
      opacity: 0.9;
      animation: float 10s infinite ease-in-out alternate;
      filter: blur(40px);
    }

    .blob:nth-child(1) {
      top: 10%;
      left: 10%;
      width: 300px;
      height: 300px;
      background: #ffc0cb;
      animation-duration: 12s;
    }

    .blob:nth-child(2) {
      bottom: 20%;
      right: 10%;
      width: 350px;
      height: 350px;
      background: #8ec5fc;
      animation-duration: 15s;
      animation-delay: -2s;
    }

    .blob:nth-child(3) {
      bottom: 10%;
      left: 20%;
      width: 300px;
      height: 300px;
      background: #e0c3fc;
      animation-duration: 18s;
      animation-delay: -5s;
    }

    .blob:nth-child(4) {
      top: 30%;
      right: 20%;
      width: 200px;
      height: 200px;
      background: #a0e9ff;
      animation-duration: 14s;
      animation-delay: -1s;
    }

    @keyframes float {
      0% {
        transform: translate(0, 0) rotate(0deg);
      }

      100% {
        transform: translate(50px, 50px) rotate(20deg);
      }
    }

    /* --- 液态玻璃核心样式 --- */
    .glass-container {
      position: relative;
      overflow: hidden;
      box-shadow: 0 6px 6px rgba(0, 0, 0, 0.2), 0 0 20px rgba(0, 0, 0, 0.1);
      border-radius: 24px;
      background: rgba(255, 255, 255, 0.25);
      height: 85vh;
      display: flex;
      flex-direction: column;
    }

    .glass-filter {
      position: absolute;
      inset: 0;
      z-index: 0;
      backdrop-filter: blur(4px);
      filter: url(#lg-dist);
      isolation: isolate;
      pointer-events: none;
    }

    .glass-specular {
      position: absolute;
      inset: 0;
      z-index: 2;
      border-radius: inherit;
      overflow: hidden;
      box-shadow: inset 1px 1px 0 rgba(255, 255, 255, 0.75),
        inset 0 0 5px rgba(255, 255, 255, 0.75);
      pointer-events: none;
    }

    .glass-content {
      position: relative;
      z-index: 10;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .glass-item {
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      transition: all 0.3s ease;
    }

    .glass-item:hover {
      background: rgba(255, 255, 255, 0.6);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .icon {
      stroke-width: 1.5px;
      fill: none;
      stroke: currentColor;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .input-focus:focus-within {
      background-color: rgba(255, 255, 255, 0.6);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .draggable {
      cursor: grab;
      user-select: none;
    }

    .draggable:active {
      cursor: grabbing;
    }
  </style>
</head>

<body class="min-h-screen flex justify-center items-center p-4 md:p-8">

  <div class="blob-cont">
    <div class="blob"></div>
    <div class="blob"></div>
    <div class="blob"></div>
    <div class="blob"></div>
  </div>

  <svg style="display: none">
    <filter height="100%" id="lg-dist" width="100%" x="0%" y="0%">
      <feTurbulence baseFrequency="0.008 0.008" numOctaves="2" result="noise" seed="92" type="fractalNoise" />
      <feGaussianBlur in="noise" result="blurred" stdDeviation="2" />
      <feDisplacementMap in="SourceGraphic" in2="blurred" scale="70" xChannelSelector="R" yChannelSelector="G" />
    </filter>
  </svg>

  <div id="app" ref="appRef" @mousedown="startDrag" @touchstart="startDrag"
    :style="{ transform: `translate(${pos.x}px, ${pos.y}px)` }"
    class="w-full max-w-3xl glass-container draggable transition-transform duration-75">

    <div class="glass-filter"></div>
    <div class="glass-specular"></div>

    <div class="glass-content">
      <div class="px-6 py-6 border-b border-white/30 flex justify-between items-end">
        <div>
          <h1 class="text-2xl font-bold tracking-tight text-black">愿望清单</h1>
          <p class="text-gray-400 text-xs mt-1 font-medium tracking-wide">已完成 {{ progress }}%</p>
        </div>

        <div class="relative w-10 h-10 flex items-center justify-center">
          <svg class="w-full h-full transform -rotate-90">
            <circle cx="20" cy="20" r="16" stroke="#f2f2f7" stroke-width="3" fill="none" />
            <circle cx="20" cy="20" r="16" stroke="#1d1d1f" stroke-width="3" fill="none" stroke-dasharray="100"
              :stroke-dashoffset="100 - (100 * progress / 100)" stroke-linecap="round"
              class="transition-all duration-700 ease-out" />
          </svg>
        </div>
      </div>

      <div class="p-4 bg-white/20">
        <div class="flex p-1 bg-black/5 rounded-lg mb-3 relative text-sm font-medium">
          <div class="absolute bg-white/80 shadow-sm rounded-md top-1 bottom-1 transition-all duration-300 ease-out"
            :class="targetOwner === 'me' ? 'left-1 w-[calc(50%-4px)]' : 'left-[50%] w-[calc(50%-4px)]'"></div>

          <button @click="targetOwner = 'me'" class="flex-1 relative z-10 py-1.5 transition-colors"
            :class="targetOwner === 'me' ? 'text-black font-bold' : 'text-gray-600'">哭哭</button>
          <button @click="targetOwner = 'him'" class="flex-1 relative z-10 py-1.5 transition-colors"
            :class="targetOwner === 'him' ? 'text-black font-bold' : 'text-gray-600'">梦梦</button>
        </div>

        <div class="flex items-center bg-white/40 rounded-xl px-4 py-3 transition-all duration-200 input-focus">
          <svg class="icon w-5 h-5 text-gray-400 mr-3" viewBox="0 0 24 24">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          <input v-model="newWish" @keyup.enter="addWish" type="text"
            class="flex-1 bg-transparent border-none outline-none text-gray-800 placeholder-gray-400 text-sm"
            placeholder="添加一个新的愿望...">
          <button @click="addWish" v-show="newWish"
            class="text-xs font-bold text-black bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-md transition-colors">
            添加
          </button>
        </div>
      </div>

      <div class="flex-1 flex flex-col md:flex-row overflow-hidden bg-white/30 relative">
        <!-- 哭哭列表 -->
        <div class="flex-1 overflow-y-auto no-scrollbar md:border-r border-white/30 transition-all duration-300"
          :class="{'hidden md:block': targetOwner === 'him' && isMobile}">
          <div
            class="px-4 py-3 text-[10px] font-bold text-gray-500 tracking-wider uppercase sticky top-0 bg-white/90 backdrop-blur-xl z-20 border-b border-white/10">
            哭哭
          </div>
          <div class="p-2">
            <ul class="space-y-1">
              <li v-for="wish in myWishes" :key="wish.id"
                class="group flex items-start p-3 rounded-lg glass-item cursor-default mb-2">
                <div @click="toggleComplete(wish)"
                  class="w-5 h-5 mt-0.5 mr-3 rounded-full border border-gray-300 flex items-center justify-center cursor-pointer transition-all shrink-0 hover:border-gray-500"
                  :class="{'bg-black border-black': wish.completed}">
                  <svg v-if="wish.completed" class="w-3 h-3 text-white stroke-2" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm transition-all"
                    :class="wish.completed ? 'text-gray-400 line-through' : 'text-gray-900'">{{ wish.content }}</p>
                  <p v-if="!wish.completed" class="text-[10px] text-gray-400 mt-1">{{ formatDate(wish.createdAt) }}</p>
                </div>
                <button @click="deleteWish(wish.id)"
                  class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity px-2">
                  <svg class="icon w-4 h-4" viewBox="0 0 24 24">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </li>
            </ul>
            <div v-if="myWishes.length === 0" class="text-center py-10 text-gray-300 text-xs">暂无愿望</div>
          </div>
        </div>

        <!-- 梦梦列表 -->
        <div class="flex-1 overflow-y-auto no-scrollbar transition-all duration-300"
          :class="{'hidden md:block': targetOwner === 'me' && isMobile}">
          <div
            class="px-4 py-3 text-[10px] font-bold text-gray-500 tracking-wider uppercase sticky top-0 bg-white/90 backdrop-blur-xl z-20 border-b border-white/10">
            梦梦
          </div>
          <div class="p-2">
            <ul class="space-y-1">
              <li v-for="wish in hisWishes" :key="wish.id"
                class="group flex items-start p-3 rounded-lg glass-item cursor-default mb-2">
                <div @click="toggleComplete(wish)"
                  class="w-5 h-5 mt-0.5 mr-3 rounded-full border border-gray-300 flex items-center justify-center cursor-pointer transition-all shrink-0 hover:border-gray-500"
                  :class="{'bg-black border-black': wish.completed}">
                  <svg v-if="wish.completed" class="w-3 h-3 text-white stroke-2" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm transition-all"
                    :class="wish.completed ? 'text-gray-400 line-through' : 'text-gray-900'">{{ wish.content }}</p>
                  <p v-if="!wish.completed" class="text-[10px] text-gray-400 mt-1">{{ formatDate(wish.createdAt) }}</p>
                </div>
                <button @click="deleteWish(wish.id)"
                  class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity px-2">
                  <svg class="icon w-4 h-4" viewBox="0 0 24 24">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </li>
            </ul>
            <div v-if="hisWishes.length === 0" class="text-center py-10 text-gray-300 text-xs">暂无愿望</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, computed, watch, onMounted } = Vue;

    // --- LeanCloud 初始化 ---
    const APP_ID = 'fNJb5kxiG5JACBivlXAuGqly-gzGzoHsz';
    const APP_KEY = '0DF5TPnflU45HnbyFvVNPLxq';
    const SERVER_URL = 'https://fnjb5kxi.lc-cn-n1-shared.com';

    if (APP_ID && APP_ID !== '你的_APP_ID') {
      AV.init({
        appId: APP_ID,
        appKey: APP_KEY,
        serverURL: SERVER_URL
      });
      console.log('%c✅ LeanCloud 已初始化，云同步模式开启', 'color: #007aff; font-weight: bold;');
    }

    const Wish = AV.Object.extend('Wish');

    createApp({
      setup() {
        const newWish = ref('');
        const targetOwner = ref('me');
        const wishes = ref([]);
        const isMobile = ref(window.innerWidth < 768);
        const isLoading = ref(false);

        const pos = ref({ x: 0, y: 0 });
        let isDragging = false;
        let startPos = { x: 0, y: 0 };
        let initialTransform = { x: 0, y: 0 };

        // 获取云端数据
        const fetchWishes = async () => {
          if (!APP_ID || APP_ID === '你的_APP_ID') return;
          isLoading.value = true;
          try {
            const query = new AV.Query('Wish');
            query.limit(1000);
            const results = await query.find();
            wishes.value = results.map(item => ({
              id: item.id,
              objectId: item.id,
              content: item.get('content'),
              completed: item.get('completed'),
              owner: item.get('owner'),
              createdAt: item.createdAt
            }));
          } catch (error) {
            // 错误码 101 表示 Class 不存在，这在第一次使用时是正常的
            if (error.code === 101) {
              console.log('☁️ 云端数据库尚为空，等待添加第一个愿望以初始化表格...');
            } else {
              console.error('获取数据失败:', error);
            }
          } finally {
            isLoading.value = false;
          }
        };

        const startDrag = (e) => {
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
          isDragging = true;
          const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
          const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
          startPos = { x: clientX, y: clientY };
          initialTransform = { ...pos.value };
          document.addEventListener('mousemove', onDrag);
          document.addEventListener('mouseup', stopDrag);
          document.addEventListener('touchmove', onDrag);
          document.addEventListener('touchend', stopDrag);
        };

        const onDrag = (e) => {
          if (!isDragging) return;
          e.preventDefault();
          const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
          const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
          const dx = clientX - startPos.x;
          const dy = clientY - startPos.y;
          pos.value = { x: initialTransform.x + dx, y: initialTransform.y + dy };
        };

        const stopDrag = () => {
          isDragging = false;
          document.removeEventListener('mousemove', onDrag);
          document.removeEventListener('mouseup', stopDrag);
          document.removeEventListener('touchmove', onDrag);
          document.removeEventListener('touchend', stopDrag);
        };

        window.addEventListener('resize', () => { isMobile.value = window.innerWidth < 768; });

        onMounted(() => {
          if (APP_ID && APP_ID !== '你的_APP_ID') {
            fetchWishes();
          } else {
            const saved = localStorage.getItem('couple-wishes-simple');
            if (saved) {
              let parsedData = JSON.parse(saved);
              wishes.value = parsedData.map(w => ({ ...w, owner: w.owner || 'me' }));
            }
          }
        });

        watch(wishes, (newVal) => {
          if (!APP_ID || APP_ID === '你的_APP_ID') {
            localStorage.setItem('couple-wishes-simple', JSON.stringify(newVal));
          }
        }, { deep: true });

        const myWishes = computed(() => wishes.value.filter(w => w.owner === 'me').sort((a, b) => a.completed - b.completed || new Date(b.createdAt) - new Date(a.createdAt)));
        const hisWishes = computed(() => wishes.value.filter(w => w.owner === 'him').sort((a, b) => a.completed - b.completed || new Date(b.createdAt) - new Date(a.createdAt)));
        const progress = computed(() => wishes.value.length === 0 ? 0 : Math.round((wishes.value.filter(w => w.completed).length / wishes.value.length) * 100));

        const addWish = async () => {
          if (!newWish.value.trim()) return;
          const content = newWish.value;
          const owner = targetOwner.value;

          if (APP_ID && APP_ID !== '你的_APP_ID') {
            const wish = new Wish();
            wish.set('content', content);
            wish.set('owner', owner);
            wish.set('completed', false);
            try {
              const savedWish = await wish.save();
              wishes.value.unshift({
                id: savedWish.id,
                objectId: savedWish.id,
                content: content,
                completed: false,
                owner: owner,
                createdAt: savedWish.createdAt
              });
            } catch (error) {
              alert('同步到云端失败');
            }
          } else {
            wishes.value.unshift({
              id: Date.now(),
              content: content,
              completed: false,
              owner: owner,
              createdAt: new Date().toISOString()
            });
          }
          newWish.value = '';
        };

        const toggleComplete = async (wish) => {
          const newStatus = !wish.completed;
          if (APP_ID && APP_ID !== '你的_APP_ID' && wish.objectId) {
            const todo = AV.Object.createWithoutData('Wish', wish.objectId);
            todo.set('completed', newStatus);
            try {
              await todo.save();
              wish.completed = newStatus;
            } catch (error) {
              alert('更新失败');
            }
          } else {
            wish.completed = newStatus;
          }

          if (wish.completed) {
            confetti({
              particleCount: 50, spread: 50, origin: { y: 0.6 },
              colors: ['#000000', '#e5e5ea', '#fbbf24'],
              disableForReducedMotion: true,
              scalar: 0.8
            });
          }
        };

        const deleteWish = async (id) => {
          if (APP_ID && APP_ID !== '你的_APP_ID') {
            const todo = AV.Object.createWithoutData('Wish', id);
            try {
              await todo.destroy();
              wishes.value = wishes.value.filter(w => w.id !== id);
            } catch (error) {
              alert('删除失败');
            }
          } else {
            wishes.value = wishes.value.filter(w => w.id !== id);
          }
        };

        const formatDate = (iso) => { const d = new Date(iso); return `${d.getMonth() + 1}/${d.getDate()}`; };

        return { newWish, targetOwner, myWishes, hisWishes, progress, isMobile, isLoading, addWish, toggleComplete, deleteWish, formatDate, pos, startDrag, appRef: ref(null) };
      }
    }).mount('#app');
  </script>
</body>

</html>